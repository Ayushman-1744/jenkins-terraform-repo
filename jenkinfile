pipeline {
    agent any

    parameters {
        choice(
            name: 'TERRAFORM_ACTION',
            choices: ['apply', 'destroy'],
            description: 'Choose whether to apply or destroy the Terraform infrastructure.'
        )
    }
    environment {
        AWS_DEFAULT_REGION = 'ap-south-1'
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }


        stage('Setup AWS Credentials') {
            steps {
                withAWS(credentials: 'aws-credentials-id', region: "${env.AWS_DEFAULT_REGION}") {
                    script {
                        echo "Using AWS credentials"
                    }
                }
            }
        }

        stage('Terraform Init') {
            steps {
                sh 'terraform init'
            }
        }

        stage('Terraform Validate') {
            steps {
                sh 'terraform validate'
            }
        }

        stage('Terraform Plan') {
            steps {
                script {
                    if (params.TERRAFORM_ACTION == 'apply') {
                        sh 'terraform plan -out=tfplan'
                    } else if (params.TERRAFORM_ACTION == 'destroy') {
                        sh 'terraform plan -destroy -out=tfplan'
                    }
                }
            }
        }

        stage('Terraform Execute') {
            steps {
                input message: "Do you want to proceed with ${params.TERRAFORM_ACTION}?"
                sh 'terraform apply --auto-approve'
            }
        }
    }

}